# 데이터 마이그레이션 가이드

## 개요

이 가이드는 기존 SUDAM 데이터베이스에서 새로운 v2 스키마로 데이터를 마이그레이션하는 방법을 설명합니다.

## 사전 준비

1. **데이터베이스 백업**
   ```bash
   npm run migrate:backup
   ```

2. **환경 변수 설정**
   - `OLD_DATABASE_URL`: 기존 데이터베이스 연결 문자열
   - `DATABASE_URL`: 새로운 데이터베이스 연결 문자열

## 마이그레이션 단계

### 1. 데이터베이스 스키마 생성

새 데이터베이스에 Prisma 스키마를 적용합니다:

```bash
cd packages/database
npx prisma migrate dev
```

### 2. 데이터 마이그레이션 실행

```bash
npm run migrate:data
```

이 스크립트는 다음을 마이그레이션합니다:
- 사용자 (Users)
- 게임 (Games)
- 인벤토리 (Inventories)
- 길드 (Guilds)

### 3. 마이그레이션 검증

```bash
npm run migrate:validate
```

이 스크립트는:
- 각 테이블의 레코드 수를 비교
- 샘플 데이터의 무결성을 검증
- 불일치 항목을 보고

## 마이그레이션 순서

1. **사용자 (Users)**
   - 기본 사용자 정보
   - 자격 증명 (Credentials)

2. **게임 (Games)**
   - 게임 레코드
   - 게임 상태 및 데이터

3. **인벤토리 (Inventories)**
   - 사용자 아이템
   - 장비 정보

4. **길드 (Guilds)**
   - 길드 정보
   - 길드 멤버

## 주의사항

1. **백업 필수**: 마이그레이션 전에 반드시 데이터베이스를 백업하세요.

2. **테스트 환경에서 먼저 실행**: 프로덕션 데이터를 마이그레이션하기 전에 테스트 환경에서 먼저 실행하세요.

3. **점진적 마이그레이션**: 대량의 데이터가 있는 경우 배치로 나누어 마이그레이션하는 것을 고려하세요.

4. **에러 처리**: 마이그레이션 중 에러가 발생하면 로그를 확인하고 문제를 해결한 후 다시 실행하세요.

## 문제 해결

### 연결 오류
- 데이터베이스 연결 문자열이 올바른지 확인
- 방화벽 설정 확인
- 데이터베이스 서버가 실행 중인지 확인

### 데이터 불일치
- 마이그레이션 로그 확인
- 검증 스크립트 실행
- 문제가 있는 레코드 수동 확인

### 성능 문제
- 대량 데이터의 경우 배치 크기 조정
- 인덱스 생성 확인
- 데이터베이스 연결 풀 설정 확인

## 롤백

마이그레이션에 문제가 발생한 경우:

1. 새 데이터베이스를 삭제
2. 백업에서 복원
3. 문제 해결 후 다시 마이그레이션

## 추가 리소스

- [Prisma Migration Guide](https://www.prisma.io/docs/guides/migrate)
- [Database Backup Best Practices](https://www.prisma.io/docs/guides/performance-and-optimization/database-backups)

