# 서버 안정화 수정 사항

## 문제 상황
Railway 배포 후 서버가 크래시를 반복하는 문제가 발생했습니다. 로그를 보면 서버가 정상적으로 시작되지만, BotScore 업데이트가 대량으로 발생한 후 크래시가 발생하는 것으로 보입니다.

## 원인 분석
1. **서버 시작 시 대량 작업**: `fixBotYesterdayScores` 함수가 서버 시작 시 즉시 실행되어 모든 유저를 메모리에 로드하고 처리
2. **메모리 부족**: 모든 유저를 한 번에 처리하면서 메모리 사용량이 급증
3. **과도한 DB 작업**: 모든 유저의 봇 점수를 동시에 업데이트하면서 DB 부하 증가

## 적용된 수정 사항

### 1. `fixBotYesterdayScores` 함수 배치 처리로 변경
- **위치**: `server/scheduledTasks.ts`
- **변경 내용**:
  - 모든 유저를 한 번에 처리하는 대신, 50명씩 배치로 처리
  - 배치 간 100ms 대기 시간 추가 (메모리 정리 시간 확보)
  - 로그 스팸 방지 (최대 10개만 로그)
  - 진행 상황 로그 추가 (10배치마다)

### 2. 서버 시작 시 실행 지연
- **위치**: `server/server.ts`
- **변경 내용**:
  - `fixBotYesterdayScores` 실행을 서버 시작 후 5분으로 지연
  - 서버가 안정화된 후 실행하여 크래시 방지
  - 타임아웃을 30초에서 2분으로 증가 (배치 처리로 더 오래 걸릴 수 있음)

### 3. 메인 게임 루프 BotScore 업데이트 최적화
- **위치**: `server/server.ts` (메인 게임 루프)
- **변경 내용**:
  - 메모리 사용량 확인 추가 (400MB 이상이면 스킵)
  - 배치 간 50ms 대기 시간 추가
  - 메모리 사용량 로그 추가

### 4. 메모리 모니터링
- **위치**: `server/server.ts`
- **기존 기능**:
  - Railway 환경에서 5분마다 메모리 사용량 로깅
  - 메모리 사용량이 500MB 이상이면 경고
  - 프로덕션에서는 300MB 이상일 때만 로깅

## Railway 리소스 설정 권장 사항

### 메모리 제한
- Railway 무료 플랜: 512MB RAM
- 권장: 최소 1GB RAM (유료 플랜)
- 현재 코드는 400MB 이상 사용 시 BotScore 업데이트를 스킵하도록 설정

### CPU 제한
- Railway 무료 플랜: 0.5 vCPU
- 권장: 최소 1 vCPU (유료 플랜)

### 확인 방법
1. Railway Dashboard → 프로젝트 선택
2. 서비스 선택 → Settings
3. Resources 섹션에서 메모리/CPU 확인

## 예상 효과

### 메모리 사용량 감소
- 배치 처리로 인해 메모리 사용량이 일정 수준으로 제한됨
- 배치 간 대기 시간으로 가비지 컬렉션 시간 확보

### 크래시 방지
- 서버 시작 시 즉시 실행하지 않아 초기 부하 감소
- 메모리 사용량이 높을 때 작업 스킵으로 크래시 방지

### 안정성 향상
- 에러 핸들링 강화
- 타임아웃 추가로 무한 대기 방지

## 모니터링

### 로그 확인 사항
1. `[OneTimeFix]` 로그: `fixBotYesterdayScores` 실행 상태
2. `[BotScoreUpdate]` 로그: 메인 게임 루프의 BotScore 업데이트 상태
3. `[Server] Memory usage` 로그: 메모리 사용량 모니터링

### 크래시 발생 시 확인
1. 메모리 사용량이 500MB 이상인지 확인
2. `fixBotYesterdayScores` 실행 중 크래시가 발생했는지 확인
3. BotScore 업데이트 중 크래시가 발생했는지 확인

## 추가 최적화 가능 사항

### 1. Prisma 쿼리 최적화
- `skip`과 `take`를 사용하여 배치로 유저 가져오기
- 현재는 모든 유저를 가져온 후 메모리에서 배치 처리

### 2. 캐시 활용
- BotScore 업데이트 결과를 캐시하여 중복 업데이트 방지

### 3. 비동기 처리 강화
- 더 작은 배치 크기 사용 (현재 50명)
- 배치 간 대기 시간 증가 (현재 100ms)

## 테스트 방법

1. **로컬 테스트**:
   ```bash
   npm run start-server
   ```
   - 서버 시작 후 5분 후 `fixBotYesterdayScores` 실행 확인
   - 메모리 사용량 로그 확인

2. **Railway 배포**:
   - Railway Dashboard에서 배포
   - 로그에서 메모리 사용량 및 BotScore 업데이트 확인
   - 크래시 발생 여부 확인

## 문제 해결

### 여전히 크래시가 발생하는 경우
1. Railway 리소스 업그레이드 고려 (메모리/CPU 증가)
2. 배치 크기를 더 작게 조정 (50 → 25)
3. 배치 간 대기 시간 증가 (100ms → 200ms)
4. `fixBotYesterdayScores` 실행을 완전히 비활성화

### 메모리 사용량이 계속 높은 경우
1. 캐시 크기 감소 (`MAX_CACHE_SIZE` 조정)
2. 불필요한 데이터 로드 제거
3. 가비지 컬렉션 힌트 추가
