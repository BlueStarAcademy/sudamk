# syntax=docker/dockerfile:1.6
# Frontend (Next.js) 서비스용 Dockerfile
# Railway 배포용

FROM node:20-alpine AS base
WORKDIR /app
ENV NODE_ENV=production

# Install pnpm
RUN corepack enable && corepack prepare pnpm@8.10.0 --activate

FROM base AS deps
# Install dependencies (including devDependencies for Prisma)
WORKDIR /app
ENV NODE_ENV=development
# Copy workspace configuration
COPY package.json pnpm-workspace.yaml ./
# Copy all package.json files first
COPY apps/web/package.json ./apps/web/
COPY packages/database/package.json ./packages/database/
COPY packages/game-logic/package.json ./packages/game-logic/
COPY packages/shared/package.json ./packages/shared/
# Copy package source code (needed for workspace dependencies)
COPY packages/database ./packages/database
COPY packages/game-logic ./packages/game-logic
COPY packages/shared ./packages/shared
# Install dependencies (including devDependencies for Prisma generation)
RUN pnpm install

FROM base AS build
# Build application
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY --from=deps /app/apps/web/node_modules ./apps/web/node_modules
COPY --from=deps /app/packages ./packages
# Copy all source files
COPY package.json pnpm-workspace.yaml ./
COPY tsconfig.json ./tsconfig.json
COPY apps/web ./apps/web
COPY apps/api/package.json ./apps/api/
COPY apps/api/src ./apps/api/src
COPY apps/api/tsconfig.json ./apps/api/
COPY packages ./packages
RUN pnpm --filter @sudam/database exec prisma generate
# Build dependencies first (needed by @sudam/web)
# @sudam/shared doesn't need build (uses src directly), but @sudam/game-logic does
RUN pnpm --filter @sudam/game-logic build
# Verify build output
RUN if [ -f "packages/game-logic/dist/index.js" ]; then \
      echo "✓ Found: packages/game-logic/dist/index.js"; \
    elif [ -f "packages/game-logic/dist/src/index.js" ]; then \
      echo "✓ Found: packages/game-logic/dist/src/index.js, moving to dist/index.js"; \
      mv packages/game-logic/dist/src/* packages/game-logic/dist/ && \
      rm -rf packages/game-logic/dist/src; \
    else \
      echo "ERROR: packages/game-logic/dist/index.js not found after build"; \
      ls -la packages/game-logic/dist/ 2>/dev/null || echo "packages/game-logic/dist does not exist"; \
      exit 1; \
    fi
# Ensure workspace packages are accessible in node_modules (for Next.js webpack)
RUN if [ ! -d "node_modules/@sudam/game-logic" ] || [ ! -f "node_modules/@sudam/game-logic/dist/index.js" ]; then \
      echo "Setting up @sudam/game-logic in node_modules" && \
      mkdir -p node_modules/@sudam && \
      if [ -L "node_modules/@sudam/game-logic" ]; then \
        rm node_modules/@sudam/game-logic; \
      fi && \
      cp -r packages/game-logic node_modules/@sudam/game-logic && \
      test -f node_modules/@sudam/game-logic/dist/index.js && echo "✓ @sudam/game-logic ready"; \
    fi
RUN if [ ! -d "node_modules/@sudam/shared" ]; then \
      echo "Setting up @sudam/shared in node_modules" && \
      mkdir -p node_modules/@sudam && \
      if [ -L "node_modules/@sudam/shared" ]; then \
        rm node_modules/@sudam/shared; \
      fi && \
      cp -r packages/shared node_modules/@sudam/shared && \
      echo "✓ @sudam/shared ready"; \
    fi
RUN pnpm --filter @sudam/web build

FROM base AS runner
WORKDIR /app
ENV NODE_ENV=production
ENV PORT=3000

# Copy built application
COPY --from=build /app/apps/web/.next ./apps/web/.next
COPY --from=build /app/apps/web/package.json ./apps/web/
# Create empty public directory (Next.js may need it, but we don't have public assets)
RUN mkdir -p ./apps/web/public
COPY --from=build /app/node_modules ./node_modules
COPY --from=build /app/apps/web/node_modules ./apps/web/node_modules
COPY --from=build /app/packages ./packages

WORKDIR /app/apps/web

# Create non-root user
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001
RUN chown -R nodejs:nodejs /app
USER nodejs

EXPOSE 3000

CMD ["pnpm", "start"]

